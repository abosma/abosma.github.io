(()=>{var $=Object.defineProperty;var q=(i,e,t)=>e in i?$(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var n=(i,e,t)=>(q(i,typeof e!="symbol"?e+"":e,t),t);var v=class v{constructor(){n(this,"renderers",new Array);n(this,"debugText",new Array);n(this,"offscreenCanvas");n(this,"offscreenContext");n(this,"displayCanvas");n(this,"displayContext")}start(){this.displayCanvas=document.querySelector("#canvas"),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.displayCanvas.width,this.offscreenCanvas.height=this.displayCanvas.height,this.displayContext=this.displayCanvas.getContext("2d"),this.offscreenContext=this.offscreenCanvas.getContext("2d"),a.log("Started RenderHandler")}static getInstance(){return v.instance||(v.instance=new v),v.instance}addRenderer(e){this.renderers.indexOf(e)==-1&&this.renderers.push(e)}addDebugText(e){this.debugText=e.slice(-20)}update(e){this.clearScreen(),this.drawRenderers(),this.drawDebug(),this.displayContext.drawImage(this.offscreenCanvas,0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)}clearScreen(){this.offscreenContext.fillRect(0,0,this.displayCanvas.width,this.displayCanvas.height)}drawRenderers(){for(let e=this.renderers.length;e--;){let t=this.renderers[e],r=t.image,o=r.width,p=r.height,f=t.gameObject.transform.position.x,b=t.gameObject.transform.position.y;this.offscreenContext.drawImage(r,f,b,o,p)}}drawDebug(){this.offscreenContext.fillStyle="white",this.offscreenContext.globalAlpha=.5,this.offscreenContext.fillRect(this.displayCanvas.width*.8,this.displayCanvas.height*.03,300,320),this.offscreenContext.font="small-caps bold 12px sans-serif",this.offscreenContext.fillStyle="black",this.offscreenContext.globalAlpha=1;for(let e=this.debugText.length;e--;)this.offscreenContext.fillText(this.debugText[e],this.displayCanvas.width*.81,this.displayCanvas.height*.06+15*e)}};n(v,"instance");var g=v;var h=class h{constructor(){h.logs=[],window.setInterval(h.printLogs,1e3)}static log(...e){!e||e.length===0||h.logs.push(...e)}static printLogs(){!h.logs||h.logs.length==0||h.renderHandler.addDebugText(h.logs)}};n(h,"renderHandler",g.getInstance()),n(h,"logs",[]);var a=h;var d=class d{constructor(){}static getInstance(){return d.instance||(d.instance=new d),d.instance}start(){document.addEventListener("keydown",e=>{e.defaultPrevented||d.pressedKeys.indexOf(e.code)==-1&&d.pressedKeys.push(e.code)}),document.addEventListener("keyup",e=>{if(e.defaultPrevented)return;let t=d.pressedKeys.indexOf(e.code);t!=-1&&d.pressedKeys.splice(t,1)}),a.log("Started InputHandler")}static keyDown(e){return this.pressedKeys.indexOf(e)!=-1}};n(d,"instance"),n(d,"pressedKeys",new Array);var m=d;var x=class{constructor(){n(this,"listeners",[]);n(this,"listenersOncer",[]);n(this,"on",e=>(this.listeners.push(e),{dispose:()=>this.off(e)}));n(this,"once",e=>{this.listenersOncer.push(e)});n(this,"off",e=>{let t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)});n(this,"emit",e=>{if(this.listeners.forEach(t=>t(e)),this.listenersOncer.length>0){let t=this.listenersOncer;this.listenersOncer=[],t.forEach(r=>r(e))}});n(this,"pipe",e=>this.on(t=>e.emit(t)))}};var l=class i{constructor(e,t){n(this,"x",0);n(this,"y",0);n(this,"toString",()=>"(x: ".concat(this.x.toPrecision(5),", y: ").concat(this.y.toPrecision(5),")"));e!==void 0&&(this.x=e),t!==void 0&&(this.y=t)}add(e){return e instanceof i?new i(this.x+e.x,this.y+e.y):new i(this.x+e,this.y+e)}subtract(e){return e instanceof i?new i(this.x-e.x,this.y-e.y):new i(this.x-e,this.y-e)}multiply(e){return e instanceof i?new i(this.x*e.x,this.y*e.y):new i(this.x*e,this.y*e)}static addVectors(e,t){return new i(e.x+t.x,e.y+t.y)}static subtractVectors(e,t){return new i(e.x-t.x,e.y-t.y)}static multiplyVectors(e,t){return new i(e.x*t.x,e.y*t.y)}static distance(e,t){return i.len(i.subtractVectors(e,t))}static normalize(e){let t=i.len(e);return new i(e.x/t,e.y/t)}static len(e){return Math.sqrt(e.x*e.x+e.y*e.y)}};var w=class{constructor(e){n(this,"gameObject");n(this,"image");e!==void 0&&(this.image=e),g.getInstance().addRenderer(this)}start(){}update(e){}};var C=class{constructor(e,t,r,o,p){n(this,"position",new l);n(this,"width");n(this,"height");n(this,"startPosition");n(this,"endPosition");n(this,"isMoving",!1);n(this,"distance");n(this,"direction");n(this,"speed");n(this,"gameObject");e!==void 0&&(this.position.x=e),t!==void 0&&(this.position.y=t),r!==void 0&&(this.width=r),o!==void 0&&(this.height=o),p!==void 0&&(this.position=p)}start(){}update(e){this.isMoving&&(this.position=l.addVectors(this.position,this.direction.multiply(this.speed*e)),l.distance(this.startPosition,this.position)>=this.distance&&(this.position=this.endPosition,this.isMoving=!1))}moveTo(e,t){this.startPosition=this.position,this.endPosition=e,this.distance=l.distance(this.startPosition,e),this.speed=t/1e3,this.direction=l.normalize(l.subtractVectors(e,this.startPosition)),this.isMoving=!0}getCenter(){let e=this.gameObject.getComponent(w);if(!e)return;let t=e.image.width,r=e.image.height;return new l(this.position.x+t/2,this.position.y+r/2)}};var u=class{constructor(){n(this,"collisionEnter",new x);n(this,"collision",new x);n(this,"collisionExit",new x);n(this,"gameObject");n(this,"transform");n(this,"collidedGameObjects",[]);n(this,"toString",()=>"".concat(this.transform.position," - (").concat(this.transform.height,", ").concat(this.transform.width,")"))}start(){this.transform=this.gameObject.getComponent(C)}update(e){}};var c=class c{constructor(){}start(){a.log("Started ObjectHandler")}static getInstance(){return c.instance||(c.instance=new c),c.instance}static addGameObject(e){c.gameObjects.indexOf(e)==-1&&c.gameObjects.push(e)}getGameObjectsWithComponent(e){let t=[];for(let r=c.gameObjects.length;r--;)c.gameObjects[r].hasComponent(u)&&t.push(c.gameObjects[r]);return t}update(e){for(let t=c.gameObjects.length;t--;)c.gameObjects[t].update(e),this.checkCollisions()}checkCollisions(){let e=this.getGameObjectsWithComponent(u);for(let t=0;t<e.length;t++)for(let r=t+1;r<e.length;r++){if(e[t]===e[r])continue;let o=e[t],p=e[r],f=o.getComponent(u),b=p.getComponent(u),E=b.collidedGameObjects.findIndex(D=>D===o),R=f.collidedGameObjects.findIndex(D=>D===p),S=this.aabbTest(o,p);S?(f.collision.emit(p),b.collision.emit(o),R===-1&&(f.collidedGameObjects.push(p),f.collisionEnter.emit(p)),E===-1&&(b.collidedGameObjects.push(o),b.collisionEnter.emit(o))):S||(R!==-1&&(f.collidedGameObjects.splice(R,1),f.collisionExit.emit(p)),E!==-1&&(b.collidedGameObjects.splice(E,1),b.collisionExit.emit(o)))}}aabbTest(e,t){return e.transform.position.x<t.transform.position.x+t.transform.width&&e.transform.position.x+e.transform.width>t.transform.position.x&&e.transform.position.y<t.transform.position.y+t.transform.height&&e.transform.position.y+e.transform.height>t.transform.position.y}};n(c,"instance"),n(c,"gameObjects",new Array);var O=c;var s=class s{static getInstance(){return s.instance||(s.instance=new s),s.instance}constructor(){}start(){window.addEventListener("mousemove",e=>{s.mouseX=e.x,s.mouseY=e.y}),window.addEventListener("mousedown",()=>{s.mouseDown=!0}),window.addEventListener("mouseup",()=>{s.mouseDown=!1}),a.log("Started MouseHandler")}static getPosition(){return new l(s.mouseX,s.mouseY)}static isOverObject(e,t){let r=s.getPosition();return Math.pow(r.x-e.x,2)+Math.pow(r.y-e.y,2)<Math.pow(t,2)}};n(s,"mouseX"),n(s,"mouseY"),n(s,"mouseDown"),n(s,"instance");var T=s;var G=class{constructor(){n(this,"speed",1);n(this,"gameObject");n(this,"canMove",!0)}start(){}update(e){this.canMove&&((m.keyDown("KeyA")||m.keyDown("ArrowLeft"))&&(this.gameObject.transform.position.x-=this.speed*e),(m.keyDown("KeyD")||m.keyDown("ArrowRight"))&&(this.gameObject.transform.position.x+=this.speed*e),(m.keyDown("KeyW")||m.keyDown("ArrowUp"))&&(this.gameObject.transform.position.y-=this.speed*e),(m.keyDown("KeyS")||m.keyDown("ArrowDown"))&&(this.gameObject.transform.position.y+=this.speed*e))}};var j=class{constructor(e){n(this,"components",new Array);n(this,"transform");n(this,"name");n(this,"toString",()=>"".concat(this.name));O.addGameObject(this),this.transform=this.addComponent(new C),this.name=e||"New GameObject",this.start()}start(){}update(e){for(let t=this.components.length;t--;)this.components[t].update(e)}addComponent(e){let t=e;return t.gameObject=this,this.components.indexOf(t)==-1?(this.components.push(t),t.start(),e):null}getComponent(e){for(let t=this.components.length;t--;){let r=this.components[t];if(r instanceof e)return r}return null}removeComponent(e){let t=-1;for(let r=this.components.length;r--;)this.components[r]==e&&(t=r);t!=-1&&this.components.splice(t,1)}hasComponent(e){for(let t=this.components.length;t--;)if(this.components[t]instanceof e)return!0;return!1}};var V=class extends j{constructor(t,r){super();n(this,"renderer");n(this,"collider");n(this,"playerMovement");this.renderer=this.addComponent(new w);let o=new Image;o.src="src/assets/player.png",o.width=r!=null&&r.width?r.width:64,o.height=r!=null&&r.height?r.height:64,this.transform.width=r!=null&&r.width?r.width:64,this.transform.height=r!=null&&r.height?r.height:64,this.renderer.image=o,this.collider=this.addComponent(new u),this.playerMovement=this.addComponent(new G),this.playerMovement.speed=.5,t&&(this.transform.position=t)}};var L=class extends j{constructor(t,r){super();n(this,"collider");n(this,"renderer");this.collider=this.addComponent(new u),this.renderer=this.addComponent(new w);let o=new Image;o.src="src/assets/wall.png",o.width=r!=null&&r.width?r.width:64,o.height=r!=null&&r.height?r.height:64,this.transform.width=r!=null&&r.width?r.width:64,this.transform.height=r!=null&&r.height?r.height:64,this.renderer.image=o,t&&(this.transform.position=t)}};var y=class y{constructor(){}static getInstance(){return y.instance||(y.instance=new y),y.instance}start(){a.log("Started LevelHander")}static loadLevel(e){a.log("Loading level: ".concat(e));let t=new Request("./src/levels/".concat(e,".json"));fetch(t).then(r=>r.json()).then(r=>{y.createObjects(r.objects).then(()=>a.log("Loaded level: ".concat(e)))})}static async createObjects(e){e.forEach(t=>{if(t.type==="wall"){new L(t.position,t.size);return}if(t.type==="player"){new V(t.position,t.size);return}})}};n(y,"instance");var I=y;var P=O.getInstance(),A=g.getInstance(),W=m.getInstance(),X=T.getInstance(),Y=I.getInstance(),H=.01,k=performance.now(),M=0;function F(){P.start(),A.start(),W.start(),X.start(),Y.start(),I.loadLevel("level_1"),window.requestAnimationFrame(K)}function K(){let i=performance.now(),e=i-k;for(k=i,M+=e;M>=H;)P.update(H),M-=H;A.update(H),a.printLogs(),window.requestAnimationFrame(K)}window.onload=()=>F();})();
//# sourceMappingURL=game.js.map
